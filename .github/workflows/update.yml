name: Update today xin wen lian bo

on:
  workflow_dispatch:
    inputs:
      skip_fetch:
        description: 'Skip fetching news (only analyze existing news)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      date:
        description: 'Date to analyze (YYYYMMDD format, leave empty for today)'
        required: false
        type: string
  schedule:
    # 东八区 (UTC+8), 所以要-8小时
    - cron: '30 12 * * *'

jobs:
  update:
    name: Update today xin wen lian bo
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写入权限来提交结果
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        if: github.event.inputs.skip_fetch != 'true'
        uses: actions/setup-node@v3
        with:
          node-version: 16
      
      - name: Install Node.js dependencies
        if: github.event.inputs.skip_fetch != 'true'
        run: npm install
      
      - name: Fetch news
        if: github.event.inputs.skip_fetch != 'true'
        run: npm run index
        continue-on-error: true  # 如果抓取失败，继续执行分析已有数据
      
      - name: Get date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            DATE="${{ github.event.inputs.date }}"
          else
            DATE=$(date +%Y%m%d)
          fi
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "Date to analyze: $DATE"
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
      
      - name: Install Python dependencies
        run: |
          uv sync
      
      - name: Check if news file exists
        id: check_news
        run: |
          if [ -f "news/${{ steps.date.outputs.date }}.md" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "News file exists for date ${{ steps.date.outputs.date }}"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "News file does not exist for date ${{ steps.date.outputs.date }}"
          fi
      
      - name: Analyze news and send Feishu notification
        id: analyze
        if: steps.check_news.outputs.exists == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_BASE_URL: ${{ secrets.OPENAI_API_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-3.5-turbo' }}
          OPENAI_TIMEOUT: ${{ secrets.OPENAI_TIMEOUT || '300' }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          FEISHU_ENABLED: ${{ secrets.FEISHU_ENABLED || 'true' }}
        run: |
          if [ "${{ github.event.inputs.skip_fetch }}" = "true" ]; then
            uv run python analyze_news.py analyze --date ${{ steps.date.outputs.date }} --force
          else
            uv run python analyze_news.py analyze --date ${{ steps.date.outputs.date }}
          fi
        continue-on-error: true  # 如果分析失败，继续执行提交
      
      - name: Configure git
        run: |
          git config --local user.email "github-actions[bot]@github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Commit changes
        if: steps.check_news.outputs.exists == 'true'
        run: |
          git add news/analysis/ results/ news/*.md news/catalogue.json README.md || true
          if ! git diff --staged --quiet; then
            git commit -m "AUTO UPDATE [bot] - ${{ steps.date.outputs.date }}"
          else
            echo "No changes to commit"
          fi
      
      - name: Push master changes
        if: steps.check_news.outputs.exists == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: master
